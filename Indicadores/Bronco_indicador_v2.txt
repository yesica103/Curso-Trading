//@version=5
indicator("Bronco indicador v3", overlay=true, max_lines_count=500, max_labels_count=500)

// ========== INPUTS ==========
riskRewardRatio = input.float(2.0, "Risk:Reward Ratio", minval=0.5)
lineLength      = 2
accountSize     = input.float(50000, "Tama침o de Cuenta")
riskPercent     = input.float(1.0, "Riesgo %")
instrumentType  = input.string("GOLD", "Instrumento", options=["GOLD", "FOREX"])
maxVisibleMC    = input.int(1, "M치ximo MC visibles", minval=1)

// ========== VISUAL ==========
showSL = input.bool(true)
showEntry = input.bool(true)
showTP = input.bool(true)
showMCColor = input.bool(true)
showInfotable = input(true,"Mostrar panel de informaci칩n")

// ========== MC ==========
bullishMC = low < low[1] and high > high[1] and close > high[1]
bearishMC = high > high[1] and low < low[1] and close < low[1]

barcolor(showMCColor and (bullishMC or bearishMC) ? color.blue : na)

// ========== Tabla informativa de calculo de lotaje ==========

var table infoTable = table.new(position.top_center, 2, 3, border_width=4)

if showInfotable and barstate.islast
    table.cell(infoTable, 0, 0, "Operaci칩n", bgcolor=color.gray, text_color=color.white)
    table.cell(infoTable, 1, 0, instrumentType)

    table.cell(infoTable, 0, 1, "Cuenta", bgcolor=color.gray, text_color=color.white)
    table.cell(infoTable, 1, 1, "$" + str.tostring(accountSize, "#,###"))

    table.cell(infoTable, 0, 2, "Riesgo %", bgcolor=color.gray, text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(riskPercent, "#.##") + "%")



// ========== ARRAYS ==========
var array<line>  mcLines   = array.new<line>()
var array<label> mcLabels  = array.new<label>()
var array<int>   mcLineQty = array.new<int>()
var array<int>   mcLabQty  = array.new<int>()

// ========== LOTAJE ==========
calcLot(account, riskP, slDist, inst) =>
    riskUSD = account * riskP / 100
    lot = inst == "GOLD" ? riskUSD / (slDist * 100) : riskUSD / ((slDist * 10000) * 10)
    math.round(lot * 1000) / 1000

// ========== DELETE ==========
deleteOldestMC() =>
    lq = array.shift(mcLineQty)
    bq = array.shift(mcLabQty)
    for i = 0 to lq - 1
        line.delete(array.shift(mcLines))
    for i = 0 to bq - 1
        label.delete(array.shift(mcLabels))

controlVisibleMC() =>
    while array.size(mcLineQty) > maxVisibleMC
        deleteOldestMC()

// ========== BULLISH ==========
if bullishMC
    int linesCreated = 0
    int labelsCreated = 0

    sl = low
    entry = close
    risk = entry - sl
    tp = entry + risk * riskRewardRatio
    lot = calcLot(accountSize, riskPercent, risk, instrumentType)

    if showSL
        array.push(mcLines, line.new(bar_index, sl, bar_index + lineLength, sl, color=color.red, width=2))
        array.push(mcLabels, label.new(bar_index + lineLength, sl, "Buy - Long \n SL: "+ str.tostring(sl, "#.###") + "\nLote:  " + str.tostring(lot), style = label.style_label_left, color=color.red, textcolor = color.white, size=size.normal))
        linesCreated += 1
        labelsCreated += 1

    if showEntry
        array.push(mcLines, line.new(bar_index, entry, bar_index + lineLength, entry, color=color.blue, width=2))
        array.push(mcLabels, label.new(bar_index + lineLength, entry, "Entry" + str.tostring(entry, "#.####"), style = label.style_label_left, color=color.blue, textcolor = color.white, size=size.normal))
        linesCreated += 1
        labelsCreated += 1

    if showTP
        array.push(mcLines, line.new(bar_index, tp, bar_index + lineLength, tp, color=color.green, width=2))
        array.push(mcLabels, label.new(bar_index + lineLength, tp, "TP: "+ str.tostring(tp, "#.###") , style=label.style_label_left, color=color.green, textcolor = color.white, size=size.normal))
        linesCreated += 1
        labelsCreated += 1

    array.push(mcLines, line.new(bar_index, sl, bar_index, tp, style=line.style_dashed))
    linesCreated += 1

    array.push(mcLineQty, linesCreated)
    array.push(mcLabQty, labelsCreated)
    controlVisibleMC()

// ========== BEARISH ==========
if bearishMC
    int linesCreated = 0
    int labelsCreated = 0

    sl = high
    entry = close
    risk = sl - entry
    tp = entry - risk * riskRewardRatio
    lot = calcLot(accountSize, riskPercent, risk, instrumentType)

    if showSL
        array.push(mcLines, line.new(bar_index, sl, bar_index + lineLength, sl, color=color.red, width=2))
        array.push(mcLabels, label.new(bar_index + lineLength, sl , "Sell- Short \nSL " + str.tostring(sl, format.mintick) +"\nLote " + str.tostring(lot), style=label.style_label_left, color=color.red, textcolor=color.white, size=size.normal))
        linesCreated += 1
        labelsCreated += 1

    if showEntry
        array.push(mcLines, line.new(bar_index, entry, bar_index + lineLength, entry, color=color.blue, width=2))
        array.push(mcLabels, label.new(bar_index + lineLength, entry, "Entrada: "+str.tostring(entry,"#.####"), style = label.style_label_left, color=color.blue, textcolor = color.white, size=size.normal ))
        linesCreated += 1
        labelsCreated += 1

    if showTP
        array.push(mcLines, line.new(bar_index, tp, bar_index + lineLength, tp, color=color.green, width=2))
        array.push(mcLabels, label.new(bar_index + lineLength, tp, "TP: "+ str.tostring(tp, "#.####"), style = label.style_label_left, color=color.green, textcolor = color.white, size=size.normal))
        linesCreated += 1
        labelsCreated += 1

    array.push(mcLines, line.new(bar_index, tp, bar_index, sl, style=line.style_dashed))
    linesCreated += 1

    array.push(mcLineQty, linesCreated)
    array.push(mcLabQty, labelsCreated)
    controlVisibleMC()


// ========== OFFSETS ==========
lineLen = 20
labelGap = 5

// ========== HTF LEVELS ==========
pwHigh = request.security(syminfo.tickerid, "W", high[1], barmerge.gaps_off, barmerge.lookahead_off)
pdHigh = request.security(syminfo.tickerid, "D", high[1], barmerge.gaps_off, barmerge.lookahead_off)
pdLow = request.security(syminfo.tickerid, "D", low[1], barmerge.gaps_off, barmerge.lookahead_off)
dailyOpen = request.security(syminfo.tickerid, "D", open, barmerge.gaps_off, barmerge.lookahead_off)

// ========== PWH ==========
var line pwhLine = na
var label pwhLabel = na
if na(pwhLine)
    pwhLine := line.new(bar_index, pwHigh, bar_index + lineLen, pwHigh, color=color.orange, width=2)
    pwhLabel := label.new(bar_index, pwHigh, "PWH", style=label.style_label_right, color=color.orange, textcolor=color.white, size=size.tiny)
else
    line.set_y1(pwhLine, pwHigh)
    line.set_y2(pwhLine, pwHigh)
    line.set_x2(pwhLine, bar_index + lineLen)
    label.set_y(pwhLabel, pwHigh)
    label.set_x(pwhLabel, bar_index + lineLen + labelGap)

// ========== PDH ==========
var line pdhLine = na
var label pdhLabel = na
if na(pdhLine)
    pdhLine := line.new(bar_index, pdHigh, bar_index + lineLen, pdHigh, color=color.gray, width=1)
    pdhLabel := label.new(bar_index, pdHigh, "PDH", style=label.style_label_right, color=color.gray, textcolor=color.white, size=size.tiny)
else
    line.set_y1(pdhLine, pdHigh)
    line.set_y2(pdhLine, pdHigh)
    line.set_x2(pdhLine, bar_index + lineLen)
    label.set_y(pdhLabel, pdHigh)
    label.set_x(pdhLabel, bar_index + lineLen + labelGap)

// ========== PDL (NUEVO) ==========
var line pdlLine = na
var label pdlLabel = na
if na(pdlLine)
    pdlLine := line.new(bar_index, pdLow, bar_index + lineLen, pdLow, color=color.purple, width=1)
    pdlLabel := label.new(bar_index, pdLow, "PDL", style=label.style_label_right, color=color.purple, textcolor=color.white, size=size.tiny)
else
    line.set_y1(pdlLine, pdLow)
    line.set_y2(pdlLine, pdLow)
    line.set_x2(pdlLine, bar_index + lineLen)
    label.set_y(pdlLabel, pdLow)
    label.set_x(pdlLabel, bar_index + lineLen + labelGap)

// ========== DAILY OPEN ==========
var line doLine = na
var label doLabel = na
if na(doLine)
    doLine := line.new(bar_index, dailyOpen, bar_index + lineLen, dailyOpen, color=color.blue, width=1, style=line.style_dotted)
    doLabel := label.new(bar_index, dailyOpen, "Daily Open", style=label.style_label_right, color=color.blue, textcolor=color.white, size=size.tiny)
else
    line.set_y1(doLine, dailyOpen)
    line.set_y2(doLine, dailyOpen)
    line.set_x2(doLine, bar_index + lineLen)
    label.set_y(doLabel, dailyOpen)
    label.set_x(doLabel, bar_index + lineLen + labelGap)